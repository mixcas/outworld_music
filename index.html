<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8">

<title>Index</title>
<script type="text/javascript" src="app/bower_components/jquery/dist/jquery.min.js"></script>
<script type="text/javascript" src="app/bower_components/velocity/jquery.velocity.min.js"></script>
<script>
  function getRandomInt(min, max) {
	  return Math.floor(Math.random() * (max - min + 1)) + min;
  }

  window.AudioContext = window.AudioContext || window.webkitAudioContext;
  var source;
  var buffer;
  var audioBuffer;
  var dropArea;
  var audioContext;
  var processor;
  var analyser;
  var sampleAudioURL = 'owm.mp3';
  var isPlayingAudio = false;

  // analysis variables
  var waveData = []; //waveform - from 0 - 1 . no sound is 0.5. Array [binCount]
  var levelsCount = 4; //should be factor of 512
  var levelHistory = []; //last 256 ave norm levels
  var volSens = 1;

  var audio = {
    init: function() {
      audioContext = new AudioContext();

      analyser = audioContext.createAnalyser();
      analyser.smoothingTimeConstant = 0.8; //0<->1. 0 is no time smoothing
      analyser.fftSize = 64;
      analyser.connect(audioContext.destination);
      binCount = analyser.frequencyBinCount; // = 512
      levelBins = Math.floor(binCount / levelsCount); //number of bins in each level
      freqByteData = new Uint8Array(binCount);
      timeByteData = new Uint8Array(binCount);

      // init sound
      source = audioContext.createBufferSource();
      source.connect(analyser);

      // Load asynchronously
      var request = new XMLHttpRequest();
      request.open('GET', sampleAudioURL, true);
      request.responseType = 'arraybuffer';


      request.onload = function() {
        audioContext.decodeAudioData(request.response, function(buffer) {

          source.buffer = buffer;
          source.start(0);
          isPlayingAudio = true;

        }, function(e) {
          console.log(e);
        });
      };

      request.send();
    },
    analyse: function() {
      //analyser.getByteTimeDomainData(timeByteData);
      analyser.getByteFrequencyData(timeByteData);

      for (var i = 0; i < binCount; i++) {
        waveData[i] = ((timeByteData[i] - 128) / 128) * volSens;
      }
    },
    render: function() {

      requestAnimationFrame(audio.render);

      if (isPlayingAudio) {

        audio.analyse();

        var shiftx = waveData[getRandomInt(50, 60)];
        var shifty = waveData[getRandomInt(410, 470)];

        var zoom = waveData[6];
        var hue = waveData[4] * 360;
        
        console.log(zoom);
          
        var mask = $('#mask');
        if (mask) {
          if( zoom > 0.005 ) {
            mask.css('transform','scale(' + zoom + ',' + zoom + ')').css('opacity', zoom * 10 - 1);
            $('#bg').css('-webkit-filter','hue-rotate(' + hue  + 'deg)');
            $('#test-bar').css('width', zoom * 100  + 'px');
            }

/*
          if (shiftx > 0.005) {
            mesh.rotation.x += shiftx;
          } else {
            mesh.rotation.x += 0.005;
          }

          if (shifty > 0.005) {
            mesh.rotation.y += shifty;
          } else {
            mesh.rotation.y += 0.005;
          }

          if (camera.position.z < 3.6) {
            camera.position.z = (camera.position.z * (zoom + 1.75));
          }

          camera.position.z = (camera.position.z * (zoom + 1));
          */

        }

      } else {
/*
        if (mesh) {

          mesh.rotation.x += 0.005;
          mesh.rotation.y += 0.005;

        }
*/

      }
    }
  };
  audio.init();
  audio.render();

</script>

<style type="text/css">
  html, body, div, span, applet, object, iframe,
  h1, h2, h3, h4, h5, h6, p, blockquote, pre,
  a, abbr, acronym, address, big, cite, code,
  del, dfn, em, img, ins, kbd, q, s, samp,
  small, strike, strong, sub, sup, tt, var,
  b, u, i, center,
  dl, dt, dd, ol, ul, li,
  fieldset, form, label, legend,
  table, caption, tbody, tfoot, thead, tr, th, td,
  article, aside, canvas, details, embed, 
  figure, figcaption, footer, header, hgroup, 
  menu, nav, output, ruby, section, summary,
  time, mark, audio, video {
    margin: 0;
    padding: 0;
    border: 0;
    font-size: 100%;
    font: inherit;
    vertical-align: baseline;
  }
  /* HTML5 display-role reset for older browsers */
  article, aside, details, figcaption, figure, 
  footer, header, hgroup, menu, nav, section {
    display: block;
  }
  body {
    line-height: 1;
  }
  ol, ul {
    list-style: none;
  }
  blockquote, q {
    quotes: none;
  }
  blockquote:before, blockquote:after,
  q:before, q:after {
    content: '';
    content: none;
  }
  table {
    border-collapse: collapse;
    border-spacing: 0;
  }

  body {
    posititon: relative;
    display: flex;
    justify-content: center;
    align-content: center;
  }

  #bg {
    background: url(img/bg.jpg) center;
    background-size: cover;
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
  }

  #mask {
    transition: all 400ms ease-out;
    max-width: 600px;
  }


</style>
</head>
<body>
<main>
    <div id="bg"></div>
    <img id="mask" src="img/mask.png">
  </div>
</main>
</body>
</html>
